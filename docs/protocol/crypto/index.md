# 分散型チャットサービスにおける暗号化システム


master keyの再発行以外は自動的に行われます。
それぞれの鍵のuuidは公開鍵のハッシュです。
暗号化、または署名したデータには使用した鍵のuuidを添付します。

jwk形式で鍵を管理します。

## master_key
この鍵は、他の鍵の信頼の基盤となります。
この鍵で署名することにより鍵の安全性を確保することができます。
この鍵を紛失したり、漏洩した場合のみ更新することができます。
アルゴリズム: rsa-pss

## Identity_key
アカウントに割り当てられた署名用鍵です。公開鍵をmaster_keyにより署名されます。
この鍵でメッセージを署名することで暗号の正当性を証明します。

鍵の有効期限はユーザーが自由に設定できますが、過剰に長い期間を設定している場合は、他のユーザーが拒絶することがあります。
ユーザーは有効期限の半分の期間で鍵を更新することを推奨します。なぜなら、送信されてから受信するまでに期限が切れる可能性があるためです。
※1年未満を推奨

相手ユーザーは新しく使われたidentity_keyを検知すると現状の鍵から今の最新の鍵をgetしその鍵が存在するか検証する。

更新: 前の鍵で新しい鍵を署名したのもとmaster keyの署名を送信
前の鍵で署名することにより鍵の時系列の改ざんを防止

アルゴリズム: rsa-pss

## account_key
アカウントに割り振られた暗号化用鍵です。これでメッセージをroom鍵を配布します。
この鍵の公開鍵を使用して相手が暗号化して送信することにより安全に通信することができます。

更新: identity_keyと同時に更新有効期限などはidentity keyに依存 identity keyの署名と共に公開鍵をサーバーにアップロード
鍵の新旧は鍵の新旧は署名に使われたidentity keyに依存する。

アルゴリズム: rsa-oaep

## room鍵
メッセージ暗号化に使用する共通鍵です。
account_keyによって暗号化されて各ユーザーに配布されます。
定期的にユーザーが更新することができる。
アルゴリズム: aes


## master Keyの再発行
master keyを紛失、または漏洩した場合、サーバーに通知し、他のユーザーへ現行の鍵の無効化を通知する。サーバーにより通知されたユーザーは紛失したユーザーの信頼関係を切断し、再び信頼関係を構築するまで暗号機能を利用して会話することができません。

master keyが漏洩し、サーバーが通知しなかった場合、サーバーへのログイン情報も同時に漏洩すればなりすまして送信されてしまうため、ユーザーはmaster keyの保護をしなければならない。

万が一サーバーが通知しなかった場合、更新されたaccount_keyとIdentity_keyの署名に全く違うmaster keyを利用している場合は拒否します。

## メッセージの受送信の流れ

各メッセージは送信時のroom_keyで暗号化され、identity_keyで署名されます。
また、各メッセージでハッシュチェーンを作成して、改ざんを検知します。


### 送信

既存のroom Keyが無効な場合、有効なaccount_keyを利用してroom_key暗号化してサーバーにアップロード。
メッセージにをroom_keyで暗号化して

### 受信
