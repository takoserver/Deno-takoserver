## 分散型チャットサービスの暗号化システム

この分散型システムは、Mastodonのようなサーバーアーキテクチャを採用しています。以下に、このシステムの暗号化プロセスと鍵管理について説明します。

### 鍵の命名と構造

1. **アカウント鍵 (account_key)**
   - 各アカウントには公開鍵と秘密鍵のペアが存在します。
   - これらの鍵を `account_key` と呼びます。

2. **ルーム鍵 (room_key)**
   - 各チャットルームには、参加する各アカウントが秘密鍵と共通鍵を持ちます。
   - これらの鍵を `room_key` と呼びます。

3. **デバイス鍵 (device_key)**
   - 各デバイスには公開鍵と秘密鍵のペアが存在します。
   - これらの鍵を `device_key` と呼びます。

### account_keyの更新

- **更新頻度:** 正常な更新は半年に一度を推奨します。
- **更新手順:**
  1. 新しい公開鍵をサーバーにアップロードする前に、古い秘密鍵で署名します。
  2. サーバーは公開鍵と署名を検証し、公開鍵をアップロードします。
  3. 公開鍵はサーバーにアップロードされます。

- **鍵の再発行:**
  - 秘密鍵が漏洩または紛失した場合、再発行が可能です。
  - 再発行すると、すべてのデバイスのセッションが切断され、アカウントの信頼がリセットされます。

- **room_keyの再発行と信頼回復:**
  - room_keyを再発行しても、以前のroom_keyで暗号化されたメッセージは復号できません。
  - 信頼回復には以下の方法があります:
    1. 直接会ってaccount_keyとroom_keyの整合性を確認する。
    2. 信頼できるメッセージングアプリ（例: Signal,
       WhatsApp）を使用してroom_keyを共有する。

### room_keyの仕様

- **目的:**
  - account_keyが漏洩した場合でも、room_keyでさらに暗号化されているため、メッセージの内容が漏洩するのを防ぎます。
  - room_keyはサーバーにアップロードされず、room内のメンバーにのみ共有されます。

- **更新手順:**
  1. 各ユーザーは事前にroom_key更新用の公開鍵をDH鍵交換を用いて共有します。
  2. room_keyを更新するユーザーは、各公開鍵を用いて新しいroom_keyを暗号化し、サーバーにアップロードします。
  3. サーバーは各公開鍵を用いて暗号化されたroom_keyを各ユーザーに配信します。
  4. 各ユーザーは自身の秘密鍵を用いて暗号化されたroom_keyを復号し、新しいroom_keyを取得します。

### ローカル環境での鍵の管理

- デバイスを紛失した場合、鍵の盗難を防ぐために以下の手順を実施します:
  1. あるデバイスでログインする場合、デバイス鍵を生成し、鍵ペアをサーバーにアップロードします。
  2. すべての鍵をデバイス鍵で暗号化し、デバイスに保存します。
  3. デバイス鍵は公開鍵のみクライアントに保存し、秘密鍵はサーバーに保存します。
  4. デバイス鍵を使用して、デバイス内の鍵を暗号化および復号します。
  5. デバイスを紛失した場合、サーバーに保存された秘密鍵を削除し、新しいデバイス鍵を生成します。

### 大人数のグループチャットでの推奨事項

- **セキュリティと信頼性:**
  - 大人数のグループチャットでは、account_keyの整合性を確認するのが難しいため、サーバーを信頼することを推奨します。
  - しかし、セキュリティを重視する場合は、直接会ってaccount_keyとroom_keyの整合性を確認することをおすすめします。

このシステムにより、分散型チャットサービスにおける暗号化と鍵管理が強化され、ユーザーのプライバシーとデータの安全性が確保されます。
