# Takos Encrypt Ink (分散型チャットサービスの暗号化システム)

この分散型システムは、Mastodonのようなサーバーアーキテクチャを採用しています。以下に、このシステムの暗号化プロセスと鍵管理について説明します。

### 鍵の命名と構造

1. **アカウント鍵 (account_key)**
   - 各アカウントには公開鍵と秘密鍵のペアが存在します。
   - これらの鍵を `account_key` と呼びます。

2. **ルーム鍵 (room_key)**
   - 各チャットルームには、参加する各アカウントが秘密鍵と共通鍵を持ちます。
   - これらの鍵を `room_key` と呼びます。

3. **デバイス鍵 (device_key)**
   - 各デバイスには公開鍵と秘密鍵のペアが存在します。
   - これらの鍵を `device_key` と呼びます。

### account_keyの更新

- **更新頻度:** 正常な更新は半年に一度を推奨します。
- **更新手順:**
  1. 新しい公開鍵をサーバーにアップロードする前に、古い秘密鍵で署名します。
  2. サーバーは公開鍵と署名を検証し、公開鍵をアップロードします。
  3. 公開鍵はサーバーにアップロードされます。

- **鍵の再発行:**
  - 秘密鍵が漏洩または紛失した場合、再発行が可能です。
  - 再発行すると、すべてのデバイスのセッションが切断され、アカウントの信頼がリセットされます。

- **room_keyの再発行と信頼回復:**
  - room_keyを再発行しても、以前のroom_keyで暗号化されたメッセージは復号できません。
  - 信頼回復には以下の方法があります:
    1. 直接会ってaccount_keyとroom_keyの整合性を確認する。
    2. 信頼できるメッセージングアプリ（例: Signal,
       WhatsApp）を使用してroom_keyを共有する。

### room_key

  account_keyの信用を利用して、room_keyの公開鍵の正当性を保証します。
  信用するユーザーのroom_keyを利用して共通鍵を生成し、メッセージを暗号化します。
  messageidを含めることにより、共通鍵の解読を防ぎます。

### 大人数のグループチャットでの推奨事項

- **セキュリティと信頼性:**
  - 大人数のグループチャットでは、account_keyの整合性を確認するのが難しいため、サーバーを信頼することを推奨します。
  - しかし、セキュリティを重視する場合は、直接会ってaccount_keyとroom_keyの整合性を確認することをおすすめします。

このシステムにより、分散型チャットサービスにおける暗号化と鍵管理が強化され、ユーザーのプライバシーとデータの安全性が確保されます。
